{% extends "rideshare/layout.html" %}

{% block content %}
<div id="page_set_location">
    <a href="/main_screen">
        <button class="btn btn-light btn-round">
            <i class="fas fa-chevron-left"></i>
        </button>
    </a>
    <h3>
        Where can we take you?
    </h3>
    <div class="location_setter">



        <form action="/set_location/" method="post">
            {% csrf_token %}
            <div class="input-group">
                <div class="input-group-prepend">
                    <div class="input-group-text">
                        start
                    </div>
                </div>
                <input id="autocomplete_start"
                       value="{{ start_address }}"
                       class="form-control"
                       placeholder="Enter your address"
                       onFocus="geolocate('start')"
                       name="start_address"
                       type="text"/>
            </div>
            <br>
            <input id="start_place_id"
                   name="start_place_id">
            <input id="start_lat"
                   name="start_lat">
            <input id="start_lng"
                   name="start_lng">
            <br>
            <br>
            <div class="input-group">
                <div class="input-group-prepend">
                    <div class="input-group-text">
                        end
                    </div>
                </div>
                <input id="autocomplete_end"
                       value="{{ end_address }}"
                       class="form-control"
                       placeholder="Enter your address"
                       onFocus="geolocate('end')"
                       name="end_address"
                       type="text"/>
            </div>
            <br>
            <input id="end_place_id"
                   name="end_place_id"
                   value="{{ end_place_id }}">
            <input id="end_lat"
                   name="end_lat">
            <input id="end_lng"
                   name="end_lng">
            <button id="submit_ride_request_form" type="submit" class="btn btn-primary">
                geolocate
            </button>
            <div id="error_msg" class="
                    {% if error|length > 0 %}
                    {% else %}
                        hidden
                    {% endif %}
                alert alert-danger">
                {% if error|length > 0 %}
                    {{ error }}
                {% else %}
                    Error...
                {% endif %}
            </div>
        </form>
        <button type="submit" class="btn btn-round mt-3 float-right"
            onclick="preload_place_info()">
            done
        </button>
    </div>

    <script>
function preload_place_info() {
    console.log("Preloading place info...");
    var start_address = $("#autocomplete_start").val();
    var end_address = $("#autocomplete_end").val();
    $.ajax({
        method: "POST",
        url: "/geocode/",
        data: {
            start_address: start_address,
            end_address: end_address,
        },
        success: function(resp) {
            $("#error_msg").addClass("hidden");
            console.log(resp);
            var start_place_id = resp["start_place_id"];
            var start_lat = resp["start_lat"];
            var start_lng = resp["start_lng"];
            var end_place_id = resp["end_place_id"];
            var end_lat = resp["end_lat"];
            var end_lng = resp["end_lng"];
            console.log("OK");
            $("#start_place_id").val(start_place_id);
            $("#start_lat").val(start_lat);
            $("#start_lng").val(start_lng);
            $("#end_place_id").val(end_place_id);
            $("#end_lat").val(end_lat);
            $("#end_lng").val(end_lng);
            $("#submit_ride_request_form").click();
        },
        error: function(resp) {
            console.log("ERROR");
            console.log(resp.responseJSON);
            $("#error_msg").html(resp.responseJSON.error);
            $("#error_msg").removeClass("hidden");
        },
    });
}
// This sample uses the Autocomplete widget to help the user select a
// place, then it retrieves the address components associated with that
// place, and then it populates the form fields with those details.
// This sample requires the Places library. Include the libraries=places
// parameter when you first load the API. For example:
// <script
// src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDfwDp5KwMFKCXAvJGozoRRxcMGyfRsopo&libraries=places">

var placeSearch, autocomplete;
var input_id = "none"; // this is defined in geolocate(input_id);

var componentForm = {
    street_number: 'short_name',
    route: 'long_name',
    locality: 'long_name',
    administrative_area_level_1: 'short_name',
    country: 'long_name',
    postal_code: 'short_name'
};

function initAutocomplete() {

    console.log("INPUT_ID: " + input_id);

    //- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
    // Create the autocomplete object, restricting the search predictions to
    // geographical location types.
    autocomplete_start = new google.maps.places.Autocomplete(
            document.getElementById('autocomplete_start'), {types: ['geocode']});

    // Avoid paying for data that you don't need by restricting the set of
    // place fields that are returned to just the address components.
    autocomplete_start.setFields(['address_component']);

    // When the user selects an address from the drop-down, populate the
    // address fields in the form.
    autocomplete_start.addListener('place_changed', fillInAddress);

    //- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
    // Create the autocomplete object, restricting the search predictions to
    // geographical location types.
    autocomplete_end = new google.maps.places.Autocomplete(
            document.getElementById('autocomplete_end'), {types: ['geocode']});

    // Avoid paying for data that you don't need by restricting the set of
    // place fields that are returned to just the address components.
    autocomplete_end.setFields(['address_component']);

    // When the user selects an address from the drop-down, populate the
    // address fields in the form.
    autocomplete_end.addListener('place_changed', fillInAddress);
}

function fillInAddress() {
    // TEMP
    // @TODO maybe geocode and get place_id, etc here.
}

// Bias the autocomplete object to the user's geographical location,
// as supplied by the browser's 'navigator.geolocation' object.
function geolocate(id) {

    console.log("geolocate(): " + id);
    input_id = id;

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            var geolocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };
            var circle = new google.maps.Circle(
                    {center: geolocation, radius: position.coords.accuracy});
        });
    }
}
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDfwDp5KwMFKCXAvJGozoRRxcMGyfRsopo&libraries=places&callback=initAutocomplete" async defer></script>
{% endblock %}
